---
import { spineModelConfig, live2dModelConfig } from "../../config/pioConfig";
import SpineModel from "./SpineModel.astro";
import Live2DModel from "./Live2DModel.astro";

// æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¨¡å‹å¯ç”¨
const hasAnyModelEnabled = spineModelConfig.enable || live2dModelConfig.enable;
---

{
  hasAnyModelEnabled && (
    <>
      {spineModelConfig.enable && <SpineModel />}
      {live2dModelConfig.enable && <Live2DModel />}
    </>
  )
}

<!-- å…¨å±€æ ·å¼ -->
<style is:global>
  /* é€šç”¨æ¨¡å‹å®¹å™¨æ ·å¼ */
  .spine-model-container,
  .live2d-container {
    transition: all 0.3s ease;
    cursor: pointer;
    user-select: none;
  }

  .spine-model-container:hover,
  .live2d-container:hover {
    transform: scale(1.02);
  }

  .spine-model-container:active,
  .live2d-container:active {
    transform: scale(0.98);
  }

  /* å“åº”å¼éšè— */
  @media (max-width: 768px) {
    .spine-model-container,
    .live2d-container {
      display: none !important;
    }
  }

  /* é’ˆå¯¹ä¸åŒä½ç½®çš„ç‰¹æ®Šæ ·å¼ */
  .spine-model-container[data-position="bottom-left"],
  .live2d-container[data-position="bottom-left"] {
    transform-origin: bottom left;
  }

  .spine-model-container[data-position="bottom-right"],
  .live2d-container[data-position="bottom-right"] {
    transform-origin: bottom right;
  }

  .spine-model-container[data-position="top-left"],
  .live2d-container[data-position="top-left"] {
    transform-origin: top left;
  }

  .spine-model-container[data-position="top-right"],
  .live2d-container[data-position="top-right"] {
    transform-origin: top right;
  }

  /* åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ */
  .model-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 8px;
    font-size: 14px;
  }

  .model-loading::before {
    content: "ğŸ¤–";
    margin-right: 8px;
    animation: bounce 1s infinite;
  }

  @keyframes bounce {
    0%,
    20%,
    50%,
    80%,
    100% {
      transform: translateY(0);
    }
    40% {
      transform: translateY(-10px);
    }
    60% {
      transform: translateY(-5px);
    }
  }
</style>

<script define:vars={{ spineModelConfig, live2dModelConfig }}>
  // æ¨¡å‹ç®¡ç†å™¨å…¨å±€è„šæœ¬
  window.modelManager = {
    spineConfig: spineModelConfig,
    live2dConfig: live2dModelConfig,

    // è·å–å¯ç”¨çš„æ¨¡å‹ç±»å‹
    getEnabledModels() {
      const enabled = [];
      if (spineModelConfig.enable) enabled.push("spine");
      if (live2dModelConfig.enable) enabled.push("live2d");
      return enabled;
    },

    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¨¡å‹å¯ç”¨
    hasAnyModelEnabled() {
      return spineModelConfig.enable || live2dModelConfig.enable;
    },

    // è·å–æŒ‡å®šç±»å‹çš„å®¹å™¨å…ƒç´ 
    getContainer(modelType) {
      return document.getElementById(
        modelType === "spine" ? "spine-model-container" : "live2d-container"
      );
    },

    // æ˜¾ç¤º/éšè—æŒ‡å®šæ¨¡å‹
    toggle(modelType, show = null) {
      const container = this.getContainer(modelType);
      if (container) {
        const shouldShow =
          show !== null ? show : container.style.display === "none";
        container.style.display = shouldShow ? "block" : "none";
        console.log(`${modelType} model ${shouldShow ? "shown" : "hidden"}`);
      }
    },

    // æ˜¾ç¤º/éšè—æ‰€æœ‰æ¨¡å‹
    toggleAll(show = null) {
      this.getEnabledModels().forEach((modelType) => {
        this.toggle(modelType, show);
      });
    },

    // è°ƒæ•´æŒ‡å®šæ¨¡å‹ä½ç½®
    setPosition(modelType, corner, offsetX = 20, offsetY = 20) {
      const container = this.getContainer(modelType);
      if (container) {
        // æ¸…é™¤æ—§çš„ä½ç½®æ ·å¼
        container.style.left = "auto";
        container.style.right = "auto";
        container.style.top = "auto";
        container.style.bottom = "auto";

        // è®¾ç½®æ–°çš„ä½ç½®
        if (corner.includes("left")) {
          container.style.left = `${offsetX}px`;
        } else {
          container.style.right = `${offsetX}px`;
        }

        if (corner.includes("top")) {
          container.style.top = `${offsetY}px`;
        } else {
          container.style.bottom = `${offsetY}px`;
        }

        // è®¾ç½®æ•°æ®å±æ€§ç”¨äºCSSæ ·å¼
        container.setAttribute("data-position", corner);

        console.log(
          `${modelType} model position set to ${corner} (${offsetX}, ${offsetY})`
        );
      }
    },

    // è·å–æŒ‡å®šæ¨¡å‹çš„é…ç½®
    getConfig(modelType) {
      return modelType === "spine" ? this.spineConfig : this.live2dConfig;
    },
  };

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener("DOMContentLoaded", () => {
    const enabledModels = window.modelManager.getEnabledModels();
    console.log(
      `Model Manager initialized with models: ${enabledModels.join(", ")}`
    );

    // åº”ç”¨æ¯ä¸ªå¯ç”¨æ¨¡å‹çš„ä½ç½®è®¾ç½®
    enabledModels.forEach((modelType) => {
      const config = window.modelManager.getConfig(modelType);
      const { corner, offsetX, offsetY } = config.position;
      window.modelManager.setPosition(
        modelType,
        corner,
        offsetX || 20,
        offsetY || 20
      );
    });
  });
</script>
